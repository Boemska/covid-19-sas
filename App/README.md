# COVID-19 CCF SAS Viya App

## About this App

Frontline ER physician and Co-Creator of the Netflix series Pandemic, Ryan McGarry MD, had this to say when [he spoke to SAS' Alyssa Farrell at this year's SAS Global Forum Executive Connection](https://www.sas.com/en_us/events/sas-global-forum/analytics-executive.html):

> "You can come with me any day, and I'll show you all the ways that you can help clinical frontline staff - as far as just the interfaces that we work with. There's so much room for improvement here, I'm not even sure we have enough time to cover it all. Of all areas of the world, how is it that healthcare seems to be so far behind on the frontline in terms of interface, and particularly the user experince?" 

This project explores a solution to the problem stated by Dr. McGarry. It implements an alternative interface to the same resource optimisation & forecasting code that powers the Visual Analytics-based CCF application in this repository. It is not as full-featured as the VA app, instead focusing on simplicity, minimal load time, and context switching efficiency.

Usability within a clinical setting is a primary consideration. The interface and its components are designed for [stylus-based interaction](https://ieeexplore.ieee.org/document/4588449), to be usable while wearing gloves/PPE, and to run on easy-to-sterilize devices (i.e. tablets). While the design primarily targets iPad and Apple Pencil, the app will work just as well on similar Android, Windows or ChromeOS stylus-enabled devices. It is shown here running on a 10.5" 2017 iPad Pro.  

<p align="center">
<img src="./covid-app-ipad.gif">
</p>

Being a CSA-bootstrapped Progressive Web App, the app can be deployed to mobile devices directly without any need for an App Store or associated third-party approval processes. It can also be configured to receive updates without any user intervention. Other features of CSA, such as project sharing, are described in the readme of the [main Boemska CSA repository](https://github.com/boemska/create-sas-app).

This project is an example of how easily Open Source technology can be used to build and deploy secure, operational tooling in environments where SAS is an available platform. While epidemiological analysis might not require the user to wear gloves, the code and approach used here can very easily be adapted to more targeted use cases, enabling mass deployment of SAS AI & ML powered tooling to frontline clinical staff.


## About CSA

This project was bootstrapped with the [Create SAS App](https://github.com/Boemska/create-sas-app) Carbon Design App. This is an extension of Facebook's [Create React App](https://github.com/facebook/create-react-app) and provides SAS and JavaScript developers a standard and effortless way to get started wih developing Apps for the SAS platform.


## Running this app
The following section details the steps required to deploy and run the Boemska Hospital Resource Optimization SAS Viya App. In order to run this application it will be necessary to copy some files to your SAS Viya Compute Server node(s) and to make one change to a SAS configuration (`autoexec_usermods.sas`) file.

### Configure the backend

#### Install the h54s adapter
This app is bootstrapped by Boemska's [IBM Carbon Design Create SAS App template](https://github.com/Boemska/create-sas-app/tree/master/carbon-ui) which is powered by Boemska's [h54s](https://github.com/Boemska/h54s). In order to run this application, we need to install the server side components for h54s.

1. Either clone the [h54s](https://github.com/Boemska/h54s) repository or copy the [h54s.sas](https://github.com/Boemska/h54s/blob/master/sasautos/h54s.sas) file to your SAS Viya Compute Server node(s). Ensure that the h54s.sas file is readable by any user who can start a SAS session.
1. Modify your Compute Server `autoexec_usermods.sas` file found in `/opt/sas/viya/config/etc/compsrv/default` and add the following lines, updating the path to your `h54s.sas` file:

	```sas
	%include "/path/to/h54s.sas" ;
	```

#### Configure the model store location	

Either clone this repository or copy the CCF folder to your Viya Compute Server node(s). We will configure the app's services to use this location in a later step of the configuration process.

#### Deploy the services
We need to register the app's start-up service (`startupService`) and the service that will actually model the scenarios that are generated by the user (`runModel`). The `startupService` is used by the application to initialize the user interface. In this app, we use the `startupService` to drive the labels for each of the input types in the scenario generator. The `runModel` service is generated by the main build script and runs the models against the supplied scenarios.

On Viya, the services are registered as Job Definitions through the SASJobExecution web application (`https://[yourViyaservice]/SASJobExeutiuon`). 

1. Create a SAS folder called `getData` in a folder where you have write permissions. Something like `/Public/Covid App`.
1. Right click on the new `getData` folder and select new file. Give the file a name `startupService`, provide and optional _Description_, ensure the type is set to **Job Definition** and ensure the server type is set to **Compute**.
1. Open the newly created job and copy the contents of the `startupService.sas` file from the _CCF/build/Boemska_ folder to the new job and click save.
1. Right click on the `startupService` job definition and select properties. From the properties menu select "Parameters". Add the following parameter and then click save:
	* Name: `_output_type`
	* Default value: `html`
	* Field type: `Character`
	* Required: `false` 
1. Right click on the new `getData` folder and select new file. Give the file a name `runModel`, provide and optional _Description_, ensure the type is set to **Job Definition** and ensure the server type is set to **Compute**.
1. Open the newly created job and copy the contents of the `runModel.sas` file from the _CCF/build/Boemska_ folder to the new job and click save. Edit the following lines:
	* Line 19 - Set the location of your `&homedir` this is the location of the CCF folder of your repository
	* Lines 25 & 26 - Configure these options as per your licensed product set
1. Right click on the `runModel` job definition and select properties. From the properties menu select "Parameters". Add the following parameter and then click save:
	* Name: `_output_type`
	* Default value: `html`
	* Field type: `Character`
	* Required: `false` 


### Configure the front end

#### Modify the adapterService configuration

Update the `config.js` file found in `./src/adapterService`. We need to update the `metadataRoot` to the location of where we deployed our `startupService` in the step above.

### Build and run the app!
From within the _App_ folder...

1. Run `yarn install`. This will install all the dependencies listed within `package.json` into a local `node_modules` folder.
1. Run `yarn run configure`. This command will run the `configure` script, a guided process for connecting your local quick-start application to your remote SAS instance.
1. Run `yarn start`. This will run the app in the development mode.  

Open [https://localhost:3000](https://localhost:3000) to view it in the browser.

If the app needs to use a proxy to communicate with the SAS server, it will open an https connection to localhost. It is generally safe to ignore the warnings, as the certificate for your localhost is self-signed and you will be communicating via loopback. To configure localhost SSL with a custom SSL certificate, follow the [steps from the Create React App documentation](https://create-react-app.dev/docs/using-https-in-development/). 

As you edit the app, the page will reload.  

You will also see any lint errors in the console.

### Deploy the app

Run `yarn build`

Builds the app for production to the `build` folder.  

It correctly bundles React in production mode and optimizes the build for the best performance.

The build is minified and the filenames include the hashes.  

Your app is ready to be deployed!

See the section about [deployment](https://facebook.github.io/create-react-app/docs/deployment) for more information.


### Boemska AppFactory
If you are deploying and developing this application using [Boemska AppFactory](https://boemskats.com/products/appfactory/) use the following to synchronise with your AF workspace:

1. From the _App_ folder of this repository run `yarn watch`
2. In a separate terminal run `serve -s build`
3. In another terminal again, change directory to the build folder and run: `bap-sync --serverUrl https://[yourAFServer]/apps/ --repoUrl repo/dev/ --workspaceID *** --authToken *** --excludes node_modules`

## Learn More about Create React App

You can learn more in the [Create React App documentation](https://facebook.github.io/create-react-app/docs/getting-started).

To learn React, check out the [React documentation](https://reactjs.org/).

### Code Splitting

This section has moved here: https://facebook.github.io/create-react-app/docs/code-splitting

### Analyzing the Bundle Size

This section has moved here: https://facebook.github.io/create-react-app/docs/analyzing-the-bundle-size

### Making a Progressive Web App

This section has moved here: https://facebook.github.io/create-react-app/docs/making-a-progressive-web-app

### Advanced Configuration

This section has moved here: https://facebook.github.io/create-react-app/docs/advanced-configuration

### Deployment

This section has moved here: https://facebook.github.io/create-react-app/docs/deployment

### `yarn build` fails to minify

This section has moved here: https://facebook.github.io/create-react-app/docs/troubleshooting#npm-run-build-fails-to-minify
